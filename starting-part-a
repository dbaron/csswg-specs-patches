From: L. David Baron <dbaron@dbaron.org>

[css-transitions] Describe what the before-style and after-style are when considering whether to start a transition.

This implements part A (and the normative part of part C) of the proposal in
http://lists.w3.org/Archives/Public/www-style/2013Mar/0297.html
as resolved in
http://lists.w3.org/Archives/Public/www-style/2013Jun/0682.html

diff --git a/css-transitions/Overview.html b/css-transitions/Overview.html
--- a/css-transitions/Overview.html
+++ b/css-transitions/Overview.html
@@ -5,17 +5,17 @@
  <head profile="http://dublincore.org/documents/2008/08/04/dc-html/ ">
   <title>CSS Transitions</title>
 
   <link href="http://purl.org/dc/terms/" rel=schema.dcterms>
   <link href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright"
    rel=dcterms.rights>
   <meta content="CSS Transitions" name=dcterms.title>
   <meta content=text name=dcterms.type>
-  <meta content=2013-09-06 name=dcterms.date>
+  <meta content=2013-09-10 name=dcterms.date>
   <meta content="L. David Baron" name=dcterms.creator>
   <meta content=W3C name=dcterms.publisher>
   <meta content="http://dev.w3.org/csswg/css3-transitions/"
    name=dcterms.identifier>
   <script defer=defer
    src="http://test.csswg.org/harness/annotate.js#css-transitions-1_dev"
    type="text/javascript"></script>
   <meta content="text/html; charset=utf-8" http-equiv=Content-Type>
@@ -35,17 +35,17 @@
 
  <body>
   <div class=head> <!--begin-logo-->
    <p><a href="http://www.w3.org/"><img alt=W3C height=48
     src="http://www.w3.org/Icons/w3c_home" width=72></a> <!--end-logo-->
 
    <h1>CSS Transitions</h1>
 
-   <h2 class="no-num no-toc" id=longstatus-date>Editor's Draft 6 September
+   <h2 class="no-num no-toc" id=longstatus-date>Editor's Draft 10 September
     2013</h2>
 
    <dl>
     <dt>This version:
 
     <dd> <a
      href="http://dev.w3.org/csswg/css3-transitions/">http://dev.w3.org/csswg/css3-transitions/</a>
 
@@ -930,21 +930,70 @@ li:hover {
     value (‘<code class=css>green</code>’) is ‘<code
     class=css>2s</code>’, so the transition from ‘<code
     class=property>blue</code>’ to ‘<code class=property>green</code>’
     takes 2 seconds. However, when the list item leaves the :hover state, the
     transition from ‘<code class=css>green</code>’ to ‘<code
     class=css>blue</code>’ takes 1 second.
   </div>
 
-  <p> When the computed value of a property changes, implementations must
-   start transitions based on the relevant item (see <a
-   href="#transition-property">the definition of ‘<code
-   class=property>transition-property</code>’</a>) in the computed value of
-   ‘<a href="#transition-property"><code
+  <p> Various things can cause the computed style of an element to change, or
+   for an element to start or stop having computed style. (For the purposes
+   of this specification, an element has computed style when it is in the
+   document tree, and does not have computed style when it is not in the
+   document tree.) These include insertion and removal of elements from the
+   document tree (which both changes whether those elements have computed
+   styles and can change the styles of other elements through selector
+   matching), changes to the document tree that cause changes to which
+   selectors match elements, changes to style sheets or style attributes, and
+   other things. This specification does not define when computed styles are
+   updated. However, when an implementation updates the computed style for an
+   element to reflect one of these changes, it must update the computed style
+   for all elements to reflect all of these changes at the same time (or at
+   least it must be undetectable that it was done at a different time). This
+   processing of a set of simultaneous style changes is called a <dfn
+   id=style-change-event>style change event</dfn>. (Implementations typically
+   have a <a href="#style-change-event">style change event</a> to correspond
+   with their desired screen refresh rate, and when up-to-date computed style
+   is needed for a script API that depends on it.)
+
+  <p> Since this specification does not define when a <a
+   href="#style-change-event">style change event</a> occurs, and thus what
+   changes to computed values are considered simultaneous, authors should be
+   aware that changing any of the transition properties a small amount of
+   time after making a change that might transition can result in behavior
+   that varies between implementations, since the changes might be considered
+   simultaneous in some implementations but not others.
+
+  <p> When a <a href="#style-change-event">style change event</a> occurs,
+   implementations must start transitions based on the computed styles that
+   changed in that event. If an element does not have a computed style either
+   before or after the style change event, then transitions are not started
+   for that element in that style change event. Otherwise, define the
+   <span>before-change style</span> as the computed style for the element as
+   of the previous <a href="#style-change-event">style change event</a>,
+   except with any styles derived from declarative animations such as CSS
+   Transitions, CSS Animations (<a href="#CSS3-ANIMATIONS"
+   rel=biblioentry>[CSS3-ANIMATIONS]<!--{{CSS3-ANIMATIONS}}--></a>), and SMIL
+   Animations (<a href="#SMIL-ANIMATION"
+   rel=biblioentry>[SMIL-ANIMATION]<!--{{SMIL-ANIMATION}}--></a>, <a
+   href="#SVG11" rel=biblioentry>[SVG11]<!--{{SVG11}}--></a>) updated to the
+   current time. Likewise, define the <span>after-change style</span> as the
+   computed style for the element based on the information known at the start
+   of that <a href="#style-change-event">style change event</a>, in other
+   words, excluding any changes resulting from CSS Transitions that start
+   during that <a href="#style-change-event">style change event</a>.
+
+  <p> For each element with a <span>before-change style</span> and an
+   <span>after-change style</span>, and each property (other than shorthands)
+   for which the <span>before-change style</span> is different from the
+   <span>after-change style</span>, implementations must start transitions
+   based on the relevant item (see <a href="#transition-property">the
+   definition of ‘<code class=property>transition-property</code>’</a>)
+   in the computed value of ‘<a href="#transition-property"><code
    class=property>transition-property</code></a>’. Corresponding to this
    item there are computed values of ‘<a href="#transition-duration"><code
    class=property>transition-duration</code></a>’ and ‘<a
    href="#transition-delay"><code
    class=property>transition-delay</code></a>’ (see <a
    href="#list-matching">the rules on matching lists</a>). Define the <dfn
    id=combined-duration>combined duration</dfn> of the transition as the sum
    of max(‘<a href="#transition-duration"><code
@@ -955,23 +1004,16 @@ li:hover {
    based on the values of ‘<a href="#transition-duration"><code
    class=property>transition-duration</code></a>’, ‘<a
    href="#transition-delay"><code
    class=property>transition-delay</code></a>’, and ‘<a
    href="#transition-timing-function"><code
    class=property>transition-timing-function</code></a>’; in other cases
    transitions do not occur.
 
-  <p> Since this specification does not define when computed values change,
-   and thus what changes to computed values are considered simultaneous,
-   authors should be aware that changing any of the transition properties a
-   small amount of time after making a change that might transition can
-   result in behavior that varies between implementations, since the changes
-   might be considered simultaneous in some implementations but not others.
-
   <p> Once the transition of a property has started, it must continue running
    based on the original timing function, duration, and delay, even if the
    ‘<a href="#transition-timing-function"><code
    class=property>transition-timing-function</code></a>’, ‘<a
    href="#transition-duration"><code
    class=property>transition-duration</code></a>’, or ‘<a
    href="#transition-delay"><code
    class=property>transition-delay</code></a>’ property changes before the
@@ -1640,16 +1682,24 @@ li:hover {
     class=css>transition-*</code>’ properties and transitionable properties
     even clearer.
 
    <li>Computed Value line for shorthands should say "see individual
     properties".
 
    <li>Define initial values of event properties, using initializers in <a
     href="#TransitionEventInit">TransitionEventInit</a>.
+
+   <li>Define the model for starting of transitions and their interaction
+    with other animations more precisely:
+    <ul>
+     <li>Define the <span>before-change style</span> and <span>after-change
+      style</span> used for the style comparison, using the new concept of a
+      <a href="#style-change-event">style change event</a>.
+    </ul>
   </ul>
 
   <p>For more details on these changes, see the version control change logs,
    which are split in two parts because of a file renaming: <a
    href="https://dvcs.w3.org/hg/csswg/log/tip/css-transitions/Overview.src.html">change
    log since 2013 March 28</a>, <a
    href="https://dvcs.w3.org/hg/csswg/log/tip/css3-transitions/Overview.src.html">change
    log before 2013 March 28</a>.
@@ -1691,16 +1741,26 @@ li:hover {
    <dd>Bert Bos; et al. <a
     href="http://www.w3.org/TR/2011/REC-CSS2-20110607"><cite>Cascading Style
     Sheets Level 2 Revision 1 (CSS 2.1) Specification.</cite></a> 7 June
     2011. W3C Recommendation. URL: <a
     href="http://www.w3.org/TR/2011/REC-CSS2-20110607">http://www.w3.org/TR/2011/REC-CSS2-20110607</a>
    </dd>
    <!---->
 
+   <dt id=CSS3-ANIMATIONS>[CSS3-ANIMATIONS]
+
+   <dd>Dean Jackson; et al. <a
+    href="http://www.w3.org/TR/2013/WD-css3-animations-20130219/"><cite>CSS
+    Animations.</cite></a> 19 February 2013. W3C Working Draft. (Work in
+    progress.) URL: <a
+    href="http://www.w3.org/TR/2013/WD-css3-animations-20130219/">http://www.w3.org/TR/2013/WD-css3-animations-20130219/</a>
+   </dd>
+   <!---->
+
    <dt id=CSS3-IMAGES>[CSS3-IMAGES]
 
    <dd>Elika J. Etemad; Tab Atkins Jr. <a
     href="http://www.w3.org/TR/2012/CR-css3-images-20120417/"><cite>CSS Image
     Values and Replaced Content Module Level 3.</cite></a> 17 April 2012. W3C
     Candidate Recommendation. (Work in progress.) URL: <a
     href="http://www.w3.org/TR/2012/CR-css3-images-20120417/">http://www.w3.org/TR/2012/CR-css3-images-20120417/</a>
    </dd>
@@ -1710,16 +1770,35 @@ li:hover {
 
    <dd>Tantek Çelik; Chris Lilley; L. David Baron. <a
     href="http://www.w3.org/TR/2011/REC-css3-color-20110607"><cite>CSS Color
     Module Level 3.</cite></a> 7 June 2011. W3C Recommendation. URL: <a
     href="http://www.w3.org/TR/2011/REC-css3-color-20110607">http://www.w3.org/TR/2011/REC-css3-color-20110607</a>
    </dd>
    <!---->
 
+   <dt id=SMIL-ANIMATION>[SMIL-ANIMATION]
+
+   <dd>Patrick Schmitz; Aaron Cohen. <a
+    href="http://www.w3.org/TR/2001/REC-smil-animation-20010904/"><cite>SMIL
+    Animation.</cite></a> 4 September 2001. W3C Recommendation. URL: <a
+    href="http://www.w3.org/TR/2001/REC-smil-animation-20010904/">http://www.w3.org/TR/2001/REC-smil-animation-20010904/</a>
+   </dd>
+   <!---->
+
+   <dt id=SVG11>[SVG11]
+
+   <dd>Erik Dahlström; et al. <a
+    href="http://www.w3.org/TR/2011/REC-SVG11-20110816/"><cite>Scalable
+    Vector Graphics (SVG) 1.1 (Second Edition).</cite></a> 16 August 2011.
+    W3C Recommendation. URL: <a
+    href="http://www.w3.org/TR/2011/REC-SVG11-20110816/">http://www.w3.org/TR/2011/REC-SVG11-20110816/</a>
+   </dd>
+   <!---->
+
    <dt id=WCAG20>[WCAG20]
 
    <dd>Ben Caldwell; et al. <a
     href="http://www.w3.org/TR/2008/REC-WCAG20-20081211/"><cite>Web Content
     Accessibility Guidelines (WCAG) 2.0.</cite></a> 11 December 2008. W3C
     Recommendation. URL: <a
     href="http://www.w3.org/TR/2008/REC-WCAG20-20081211/">http://www.w3.org/TR/2008/REC-WCAG20-20081211/</a>
    </dd>
@@ -1843,16 +1922,19 @@ li:hover {
    <li>&lt;single-transition-property&gt;, <a
     href="#single-transition-property"
     title="section 2.1."><strong>2.1.</strong></a>
 
    <li>&lt;single-transition-timing-function&gt;, <a
     href="#single-transition-timing-function"
     title="section 2.3."><strong>2.3.</strong></a>
 
+   <li>style change event, <a href="#style-change-event"
+    title="section 3."><strong>3.</strong></a>
+
    <li>transition, <a href="#transition"
     title="section 2.5."><strong>2.5.</strong></a>
 
    <li>transition-delay, <a href="#transition-delay"
     title="section 2.4."><strong>2.4.</strong></a>
 
    <li>transition-duration, <a href="#transition-duration"
     title="section 2.2."><strong>2.2.</strong></a>
diff --git a/css-transitions/Overview.src.html b/css-transitions/Overview.src.html
--- a/css-transitions/Overview.src.html
+++ b/css-transitions/Overview.src.html
@@ -907,45 +907,105 @@ li:hover {
           'background-color' would have its new value (''green'') is ''2s'',
           so the transition from 'blue' to 'green' takes 2 seconds.
           However, when the list item leaves the :hover state, the
           transition from ''green'' to ''blue'' takes 1 second.
         </p>
       </div>
 
       <p>
-        When the computed value of a property changes, implementations
-        must start transitions based on the relevant item (see <a
+        Various things can cause the computed style of an element to change,
+        or for an element to start or stop having computed style.
+        (For the purposes of this specification,
+        an element has computed style when it is in the document tree,
+        and does not have computed style when it is not in the document tree.)
+        These include
+        insertion and removal of elements from the document tree
+        (which both changes whether those elements have computed styles and
+        can change the styles of other elements through selector matching),
+        changes to the document tree that cause
+        changes to which selectors match elements,
+        changes to style sheets or style attributes,
+        and other things.
+        This specification does not define when computed styles are updated.
+        However,
+        when an implementation updates the computed style for an element
+        to reflect one of these changes,
+        it must update the computed style for all elements to reflect all
+        of these changes at the same time
+        (or at least it must be undetectable that it was done at a
+        different time).
+        This processing of a set of simultaneous style changes is called a
+        <dfn>style change event</dfn>.
+        (Implementations typically have a <span>style change event</span> to
+        correspond with their desired screen refresh rate,
+        and when up-to-date computed style is needed
+        for a script API that depends on it.)
+      </p>
+
+      <p>
+        Since this specification does not define
+        when a <span>style change event</span> occurs,
+        and thus what changes to computed values are considered simultaneous,
+        authors should be aware that changing any of the transition
+        properties a small amount of time after making a change that
+        might transition can result in behavior that varies between
+        implementations, since the changes might be considered
+        simultaneous in some implementations but not others.
+      </p>
+
+      <p>
+        When a <span>style change event</span> occurs,
+        implementations must start transitions based on
+        the computed styles that changed in that event.
+        If an element does not have a computed style
+        either before or after the style change event,
+        then transitions are not started for that element
+        in that style change event.
+        Otherwise,
+        define the <span>before-change style</span> as
+        the computed style for the element as of
+        the previous <span>style change event</span>,
+        except with any styles derived from declarative
+        animations such as CSS Transitions, CSS Animations
+        ([[CSS3-ANIMATIONS]]),
+        and SMIL Animations ([[SMIL-ANIMATION]], [[SVG11]])
+        updated to the current time.
+        Likewise, define the <span>after-change style</span> as
+        the computed style for the element based on the information
+        known at the start of that <span>style change event</span>,
+        in other words,
+        excluding any changes resulting from CSS Transitions
+        that start during that <span>style change event</span>.
+      </p>
+
+      <p>
+        For each element with a <span>before-change style</span> and
+        an <span>after-change style</span>,
+        and each property (other than shorthands) for which
+        the <span>before-change style</span> is different from
+        the <span>after-change style</span>,
+        implementations must
+        start transitions based on the relevant item (see <a
         href="#transition-property">the definition of
         'transition-property'</a>) in the computed value of
         'transition-property'.
         Corresponding to this item there are
         computed values of 'transition-duration' and 'transition-delay'
         (see <a href="#list-matching">the rules on matching lists</a>).
         Define the <dfn>combined duration</dfn> of the transition
         as the sum of max('transition-duration', ''0s'') and 'transition-delay'.
         When the combined duration is greater than ''0s'',
         then a transition starts based on the values of
         'transition-duration', 'transition-delay',
         and 'transition-timing-function';
         in other cases transitions do not occur.
       </p>
 
       <p>
-        Since this specification does not define
-        when computed values change, and thus what changes to
-        computed values are considered simultaneous,
-        authors should be aware that changing any of the transition
-        properties a small amount of time after making a change that
-        might transition can result in behavior that varies between
-        implementations, since the changes might be considered
-        simultaneous in some implementations but not others.
-      </p>
-
-      <p>
         Once the transition of a property has started, it must continue
         running based on the original timing function, duration, and
         delay, even if the 'transition-timing-function',
         'transition-duration', or 'transition-delay' property changes
         before the transition is complete.  However, if the
         'transition-property' property changes such that the transition
         would not have started, the transition must stop (and the
         property must immediately change to its final value).
@@ -1553,16 +1613,20 @@ li:hover {
 dated 12 February 2013</a>:</p>
 
 <ul>
   <li>Fixed missed substitution (<span>TransitionEventInit</span> rather than AnimationEventInit) when copying event IDL from css3-animations.
   <li>Make naming of event constructor dictionary parameters more consistent with DOM-Level-3-Events.
   <li>Make the behavior of simultaneous changes of 'transition-*' properties and transitionable properties even clearer.
   <li>Computed Value line for shorthands should say "see individual properties".
   <li>Define initial values of event properties,  using initializers in <span>TransitionEventInit</span>.
+  <li>Define the model for starting of transitions and their interaction with other animations more precisely:
+    <ul>
+      <li>Define the <span>before-change style</span> and <span>after-change style</span> used for the style comparison, using the new concept of a <span>style change event</span>.
+    </ul>
 </ul>
 
 <p>For more details on these changes, see the version control change logs, which are split in two parts because of a file renaming: <a href="https://dvcs.w3.org/hg/csswg/log/tip/css-transitions/Overview.src.html">change log since 2013 March 28</a>, <a href="https://dvcs.w3.org/hg/csswg/log/tip/css3-transitions/Overview.src.html">change log before 2013 March 28</a>.
 
 <p>For changes in previous working drafts, see
 <a href="http://www.w3.org/TR/2013/WD-css3-transitions-20130212/ChangeLog">the ChangeLog</a>, and the above version control logs.</p>
 
 <h2 id="acknowledgments">Acknowledgments</h2>
